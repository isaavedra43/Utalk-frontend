
### üí¨ Endpoints de Mensajes

#### GET /api/conversations/:conversationId/messages
```javascript
// Query Parameters
{
  "limit": 50,
  "cursor": "base64_encoded_cursor",
  "direction": "inbound", // "inbound", "outbound", "all"
  "status": "sent", // "sent", "delivered", "read", "failed"
  "type": "text", // "text", "image", "audio", "video", "document"
  "startDate": "2025-01-01T00:00:00Z",
  "endDate": "2025-01-15T23:59:59Z"
}

// Response
{
  "success": true,
  "data": [/* array de mensajes */],
  "pagination": {
    "hasMore": true,
    "nextCursor": "base64_encoded_cursor",
    "totalResults": 150,
    "limit": 50
  }
}
```

#### POST /api/conversations/:conversationId/messages
```javascript
// Request (Texto simple)
{
  "content": "Hola mundo",
  "type": "text",
  "replyToMessageId": null
}

// Request (Con archivos)
const formData = new FormData();
formData.append('content', 'Aqu√≠ tienes el documento');
formData.append('type', 'document');
formData.append('attachments', file1);
formData.append('attachments', file2);

// Response
{
  "success": true,
  "data": { /* modelo de mensaje completo */ }
}
```

#### PUT /api/conversations/:conversationId/messages/:messageId
```javascript
// Request
{
  "content": "Mensaje editado",
  "type": "text"
}

// Response
{
  "success": true,
  "data": { /* modelo de mensaje completo */ }
}
```

#### PUT /api/conversations/:conversationId/messages/:messageId/read
```javascript
// Request
{
  "readAt": "2025-01-15T10:35:00Z"
}

// Response
{
  "success": true,
  "data": {
    "messageId": "msg_123",
    "readBy": ["admin@company.com"],
    "readAt": "2025-01-15T10:35:00Z"
  }
}
```

#### DELETE /api/conversations/:conversationId/messages/:messageId
```javascript
// Request
// DELETE /api/conversations/550e8400-e29b-41d4-a716-446655440000/messages/msg_123

// Response
{
  "success": true,
  "message": "Mensaje eliminado",
  "data": {
    "messageId": "msg_123",
    "deletedAt": "2025-01-15T10:30:00Z"
  }
}
```

### üë§ Endpoints de Contactos

#### GET /api/contacts
```javascript
// Query Parameters
{
  "page": 1,
  "limit": 20,
  "search": "Juan",
  "tags": ["vip"],
  "isActive": true
}

// Response
{
  "success": true,
  "data": [/* array de contactos */],
  "pagination": {
    "hasMore": true,
    "nextCursor": "base64_encoded_cursor",
    "totalResults": 50,
    "limit": 20
  }
}
```

#### GET /api/contacts/:id
```javascript
// Request
// GET /api/contacts/+521234567890

// Response
{
  "success": true,
  "data": { /* modelo de contacto completo */ }
}
```

#### POST /api/contacts
```javascript
// Request
{
  "name": "Juan P√©rez",
  "phone": "+521234567890",
  "email": "juan@example.com",
  "company": "Empresa ABC",
  "notes": "Cliente VIP",
  "tags": ["vip", "recurrente"]
}

// Response
{
  "success": true,
  "data": { /* modelo de contacto completo */ }
}
```

#### PUT /api/contacts/:id
```javascript
// Request
{
  "name": "Juan P√©rez Actualizado",
  "email": "juan.nuevo@example.com",
  "company": "Nueva Empresa",
  "notes": "Cliente VIP actualizado",
  "tags": ["vip", "recurrente", "actualizado"]
}

// Response
{
  "success": true,
  "data": { /* modelo de contacto completo */ }
}
```

#### DELETE /api/contacts/:id
```javascript
// Request
// DELETE /api/contacts/+521234567890

// Response
{
  "success": true,
  "message": "Contacto eliminado",
  "data": {
    "contactId": "+521234567890",
    "deletedAt": "2025-01-15T10:30:00Z"
  }
}
```

### üìé Endpoints de Archivos

#### POST /api/files/upload
```javascript
// Request
const formData = new FormData();
formData.append('file', file);
formData.append('conversationId', '550e8400-e29b-41d4-a716-446655440000');

// Response
{
  "success": true,
  "data": { /* modelo de archivo completo */ }
}
```

#### GET /api/files/:id
```javascript
// Request
// GET /api/files/file_123

// Response
{
  "success": true,
  "data": { /* modelo de archivo completo */ }
}
```

#### GET /api/files/:id/download
```javascript
// Request
// GET /api/files/file_123/download

// Response
// Redirecci√≥n a URL de descarga o stream del archivo
```

#### DELETE /api/files/:id
```javascript
// Request
// DELETE /api/files/file_123

// Response
{
  "success": true,
  "message": "Archivo eliminado",
  "data": {
    "fileId": "file_123",
    "deletedAt": "2025-01-15T10:30:00Z"
  }
}
```

### üìä Endpoints de Estad√≠sticas

#### GET /api/stats/conversations
```javascript
// Query Parameters
{
  "period": "7d", // "1d", "7d", "30d", "90d"
  "agentEmail": "admin@company.com",
  "status": "open"
}

// Response
{
  "success": true,
  "data": {
    "total": 150,
    "open": 45,
    "pending": 20,
    "resolved": 80,
    "archived": 5,
    "avgResponseTime": "2h 30m",
    "avgResolutionTime": "1d 5h"
  }
}
```

#### GET /api/stats/messages
```javascript
// Query Parameters
{
  "period": "7d",
  "conversationId": "550e8400-e29b-41d4-a716-446655440000",
  "type": "text"
}

// Response
{
  "success": true,
  "data": {
    "total": 1250,
    "inbound": 800,
    "outbound": 450,
    "byType": {
      "text": 1000,
      "image": 150,
      "document": 80,
      "audio": 15,
      "video": 5
    },
    "avgPerConversation": 25
  }
}
```

---

## üìã MODELOS JSON COMPLETOS

### üîê Modelo de Usuario/Autenticaci√≥n Completo

#### Respuesta de Login
```javascript
{
  "success": true,
  "data": {
    "user": {
      "id": "admin@company.com",
      "email": "admin@company.com",
      "name": "Admin User",
      "role": "admin",
      "isActive": true,
      "avatar": null,
      "lastSeen": "2025-01-15T10:30:00Z",
      "isOnline": true,
      "permissions": [
        "read_conversations",
        "write_messages", 
        "assign_conversations",
        "manage_users",
        "view_stats"
      ],
      "createdAt": "2025-01-01T00:00:00Z",
      "updatedAt": "2025-01-15T10:30:00Z"
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresIn": 3600,
      "tokenType": "Bearer"
    }
  }
}
```

#### Respuesta de Refresh Token
```javascript
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 3600,
    "tokenType": "Bearer"
  }
}
```

#### Respuesta de Logout
```javascript
{
  "success": true,
  "message": "Logout exitoso",
  "data": {
    "loggedOutAt": "2025-01-15T10:30:00Z"
  }
}
```

### üí¨ Modelo de Conversaci√≥n Completo

#### Conversaci√≥n B√°sica
```javascript
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "participants": ["+521234567890", "admin@company.com"],
  "customerPhone": "+521234567890",
  "contact": {
    "id": "+521234567890",
    "name": "Juan P√©rez",
    "phone": "+521234567890",
    "email": "juan@example.com",
    "avatar": "https://example.com/avatar.jpg",
    "company": "Empresa ABC",
    "notes": "Cliente VIP",
    "channel": "whatsapp",
    "createdAt": "2025-01-01T00:00:00Z",
    "updatedAt": "2025-01-15T10:30:00Z"
  },
  "assignedTo": {
    "id": "admin@company.com",
    "name": "Admin User",
    "email": "admin@company.com",
    "role": "admin"
  },
  "status": "open", // "open", "pending", "resolved", "archived"
  "priority": "normal", // "low", "normal", "high", "urgent"
  "tags": ["vip", "urgente"],
  "unreadCount": 2,
  "messageCount": 15,
  "lastMessage": {
    "id": "msg_123",
    "content": "Hola, ¬øc√≥mo est√°s?",
    "timestamp": "2025-01-15T10:30:00Z",
    "sender": "customer",
    "type": "text",
    "status": "delivered"
  },
  "lastMessageId": "msg_123",
  "lastMessageAt": "2025-01-15T10:30:00Z",
  "createdAt": "2025-01-15T09:00:00Z",
  "updatedAt": "2025-01-15T10:30:00Z",
  "metadata": {
    "source": "whatsapp",
    "autoAssigned": false,
    "favorite": false
  }
}
```

### üí¨ Modelo de Mensaje Completo

#### Mensaje de Texto
```javascript
{
  "id": "msg_123",
  "conversationId": "550e8400-e29b-41d4-a716-446655440000",
  "content": "Hola, ¬øc√≥mo est√°s?",
  "mediaUrl": null,
  "senderIdentifier": "+521234567890",
  "recipientIdentifier": "admin@company.com",
  "sender": {
    "identifier": "+521234567890",
    "type": "customer",
    "name": "Juan P√©rez"
  },
  "recipient": {
    "identifier": "admin@company.com",
    "type": "agent",
    "name": "Admin User"
  },
  "direction": "inbound", // "inbound", "outbound"
  "type": "text", // "text", "image", "audio", "video", "document", "location"
  "status": "delivered", // "sent", "delivered", "read", "failed"
  "timestamp": "2025-01-15T10:30:00Z",
  "metadata": {
    "twilioSid": "SM1234567890",
    "sentViaSocket": false,
    "socketId": null,
    "readBy": ["admin@company.com"],
    "readAt": "2025-01-15T10:35:00Z"
  },
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### Mensaje con Archivo Adjunto
```javascript
{
  "id": "msg_124",
  "conversationId": "550e8400-e29b-41d4-a716-446655440000",
  "content": "Aqu√≠ tienes el documento",
  "mediaUrl": "https://storage.googleapis.com/utalk-files/document.pdf",
  "senderIdentifier": "admin@company.com",
  "recipientIdentifier": "+521234567890",
  "sender": {
    "identifier": "admin@company.com",
    "type": "agent",
    "name": "Admin User"
  },
  "recipient": {
    "identifier": "+521234567890",
    "type": "customer",
    "name": "Juan P√©rez"
  },
  "direction": "outbound",
  "type": "document",
  "status": "sent",
  "timestamp": "2025-01-15T10:40:00Z",
  "metadata": {
    "twilioSid": "SM1234567891",
    "sentViaSocket": true,
    "socketId": "socket_123",
    "fileInfo": {
      "filename": "document.pdf",
      "size": 1024000,
      "mimeType": "application/pdf",
      "thumbnail": "https://storage.googleapis.com/utalk-files/thumbnails/document.jpg"
    }
  },
  "createdAt": "2025-01-15T10:40:00Z",
  "updatedAt": "2025-01-15T10:40:00Z"
}
```

#### Mensaje Fallido
```javascript
{
  "id": "msg_125",
  "conversationId": "550e8400-e29b-41d4-a716-446655440000",
  "content": "Mensaje que fall√≥",
  "mediaUrl": null,
  "senderIdentifier": "admin@company.com",
  "recipientIdentifier": "+521234567890",
  "sender": {
    "identifier": "admin@company.com",
    "type": "agent",
    "name": "Admin User"
  },
  "recipient": {
    "identifier": "+521234567890",
    "type": "customer",
    "name": "Juan P√©rez"
  },
  "direction": "outbound",
  "type": "text",
  "status": "failed",
  "timestamp": "2025-01-15T10:45:00Z",
  "metadata": {
    "failureReason": "Invalid phone number",
    "twilioError": "21211",
    "retryable": true,
    "retryCount": 0,
    "maxRetries": 3
  },
  "createdAt": "2025-01-15T10:45:00Z",
  "updatedAt": "2025-01-15T10:45:00Z"
}
```

### üë§ Modelo de Contacto Completo

#### Contacto Completo
```javascript
{
  "id": "+521234567890",
  "name": "Juan P√©rez",
  "phone": "+521234567890",
  "email": "juan@example.com",
  "avatar": "https://example.com/avatar.jpg",
  "company": "Empresa ABC",
  "notes": "Cliente VIP con preferencias especiales",
  "channel": "whatsapp",
  "isActive": true,
  "tags": ["vip", "recurrente"],
  "metadata": {
    "lastContact": "2025-01-15T10:30:00Z",
    "totalConversations": 5,
    "totalMessages": 150,
    "preferredLanguage": "es"
  },
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### Contacto M√≠nimo (Solo Tel√©fono)
```javascript
{
  "id": "+521234567890",
  "name": null,
  "phone": "+521234567890",
  "email": null,
  "avatar": null,
  "company": null,
  "notes": null,
  "channel": "whatsapp",
  "isActive": true,
  "tags": [],
  "metadata": {
    "lastContact": "2025-01-15T10:30:00Z",
    "totalConversations": 1,
    "totalMessages": 3,
    "preferredLanguage": "es"
  },
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

### üìé Modelo de Archivo Adjunto Completo

#### Archivo Subido Exitosamente
```javascript
{
  "id": "file_123",
  "filename": "document.pdf",
  "originalName": "documento_importante.pdf",
  "size": 1024000,
  "mimeType": "application/pdf",
  "url": "https://storage.googleapis.com/utalk-files/document.pdf",
  "thumbnail": "https://storage.googleapis.com/utalk-files/thumbnails/document.jpg",
  "metadata": {
    "uploadedBy": "admin@company.com",
    "uploadedAt": "2025-01-15T10:40:00Z",
    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
    "messageId": "msg_124"
  },
  "status": "uploaded", // "uploading", "uploaded", "failed"
  "createdAt": "2025-01-15T10:40:00Z",
  "updatedAt": "2025-01-15T10:40:00Z"
}
```

#### Archivo en Proceso de Subida
```javascript
{
  "id": "file_124",
  "filename": "image.jpg",
  "originalName": "foto.jpg",
  "size": 2048000,
  "mimeType": "image/jpeg",
  "url": null,
  "thumbnail": null,
  "metadata": {
    "uploadedBy": "admin@company.com",
    "uploadedAt": null,
    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
    "messageId": null,
    "progress": 45
  },
  "status": "uploading",
  "createdAt": "2025-01-15T10:50:00Z",
  "updatedAt": "2025-01-15T10:50:00Z"
}
```

#### Archivo con Error de Subida
```javascript
{
  "id": "file_125",
  "filename": "large_video.mp4",
  "originalName": "video_grande.mp4",
  "size": 104857600,
  "mimeType": "video/mp4",
  "url": null,
  "thumbnail": null,
  "metadata": {
    "uploadedBy": "admin@company.com",
    "uploadedAt": null,
    "conversationId": "550e8400-e29b-41d4-a716-446655440000",
    "messageId": null,
    "error": "File too large",
    "errorCode": "FILE_TOO_LARGE"
  },
  "status": "failed",
  "createdAt": "2025-01-15T10:55:00Z",
  "updatedAt": "2025-01-15T10:55:00Z"
}
```

### üìã Fase 4: Chat en Tiempo Real

#### 4.1 Componente de Chat
```svelte
<!-- src/routes/conversation/[id]/+page.svelte -->
<script lang="ts">
  import { onMount, onDestroy } from 'svelte';
  import { page } from '$app/stores';
  import { api } from '$lib/services/axios';
  import { socketManager } from '$lib/services/socket';
  import { validateMessage, validateFileUpload } from '$lib/utils/validation';
  import { safeDateToISOString } from '$lib/utils/dates';
  
  let messages: Message[] = [];
  let conversation: Conversation | null = null;
  let newMessage = '';
  let selectedFiles: File[] = [];
  let loading = true;
  let error = '';
  let canSend = false;

  $: conversationId = $page.params.id;

  onMount(async () => {
    await loadConversation();
    await loadMessages();
    setupSocketListeners();
    loading = false;
  });

  onDestroy(() => {
    // Limpiar listeners
    socketManager.socket?.off('new-message');
    socketManager.socket?.off('message-status-updated');
  });

  async function loadConversation() {
    try {
      const response = await api.get(`/conversations/${conversationId}`);
      conversation = response.data;
      canSend = conversation.assignedTo !== null;
    } catch (err: any) {
      error = err.response?.data?.message || 'Error al cargar conversaci√≥n';
    }
  }

  async function loadMessages() {
    try {
      const response = await api.get(`/conversations/${conversationId}/messages`);
      messages = response.data;
    } catch (err: any) {
      error = 'Error al cargar mensajes';
    }
  }

  function setupSocketListeners() {
    socketManager.socket?.on('new-message', (message: Message) => {
      if (message.conversationId === conversationId) {
        messages = [...messages, message];
      }
    });

    socketManager.socket?.on('message-status-updated', (data: any) => {
      messages = messages.map(msg => 
        msg.id === data.messageId 
          ? { ...msg, status: data.status, metadata: data.metadata }
          : msg
      );
    });
  }

  function handleFileSelect(event: Event) {
    const target = event.target as HTMLInputElement;
    const files = Array.from(target.files || []);
    
    const validation = validateFileUpload(files);
    if (!validation.valid) {
      error = validation.error || 'Error en archivos';
      return;
    }
    
    selectedFiles = files;
  }

  async function sendMessage() {
    const validation = validateMessage(newMessage);
    if (!validation.valid) {
      error = validation.error || 'Error en mensaje';
      return;
    }

    if (!canSend) {
      error = 'No puedes enviar mensajes a esta conversaci√≥n';
      return;
    }

    try {
      const formData = new FormData();
      formData.append('text', newMessage);
      
      selectedFiles.forEach(file => {
        formData.append('attachments', file);
      });

      const response = await api.post(`/conversations/${conversationId}/messages`, formData);
      
      // El mensaje se agregar√° autom√°ticamente via socket
      newMessage = '';
      selectedFiles = [];
      error = '';
    } catch (err: any) {
      error = err.response?.data?.message || 'Error al enviar mensaje';
    }
  }

  function renderMessage(message: Message) {
    const isOwnMessage = message.sender === 'current-user';
    const date = safeDateToISOString(message.timestamp);
    
    return (
      <div class="message" class:own={isOwnMessage} class:failed={message.status === 'failed'}>
        <div class="message-content">
          <p>{message.text}</p>
          {message.metadata?.failureReason && (
            <div class="error-message">
              {message.metadata.failureReason}
              {message.metadata.retryable && (
                <button class="retry-button">Reintentar</button>
              )}
            </div>
          )}
        </div>
        <div class="message-time">
          {date ? new Date(date).toLocaleTimeString() : 'Hora no disponible'}
        </div>
      </div>
    );
  }
</script>

<div class="chat-container">
  {#if loading}
    <div class="loading">Cargando conversaci√≥n...</div>
  {:else if error}
    <div class="error">{error}</div>
  {:else if !conversation}
    <div class="error">Conversaci√≥n no encontrada</div>
  {:else}
    <div class="chat-header">
      <h2>{conversation.contact?.name || conversation.contact?.phone || 'Sin nombre'}</h2>
      {#if !conversation.assignedTo}
        <div class="warning">Sin agente asignado - No se pueden enviar mensajes</div>
      {/if}
    </div>

    <div class="messages-container">
      {#each messages as message}
        {renderMessage(message)}
      {/each}
    </div>

    <div class="message-input" class:disabled={!canSend}>
      <textarea 
        bind:value={newMessage}
        placeholder={canSend ? "Escribe tu mensaje..." : "Asigna un agente para enviar mensajes"}
        disabled={!canSend}
        maxlength="4096"
      />
      
      <input 
        type="file" 
        multiple 
        accept="image/*,audio/*,video/*,.pdf"
        on:change={handleFileSelect}
        disabled={!canSend}
      />
      
      <button on:click={sendMessage} disabled={!canSend || !newMessage.trim()}>
        Enviar
      </button>
    </div>
  {/if}
</div>
```

### üìã Fase 5: Manejo de Errores y Estados Especiales

#### 5.1 Componente de Notificaciones
```svelte
<!-- src/lib/components/Notification.svelte -->
<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  
  export let type: 'success' | 'error' | 'warning' | 'info' = 'info';
  export let message: string = '';
  export let duration: number = 5000;
  
  const dispatch = createEventDispatcher();
  
  let visible = true;
  
  if (duration > 0) {
    setTimeout(() => {
      visible = false;
      dispatch('close');
    }, duration);
  }
</script>

{#if visible}
  <div class="notification" class:notification-{type}>
    <span class="message">{message}</span>
    <button class="close-button" on:click={() => visible = false}>
      √ó
    </button>
  </div>
{/if}

<style>
  .notification {
    padding: 1rem;
    border-radius: 4px;
    margin: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .notification-success { background-color: #d4edda; color: #155724; }
  .notification-error { background-color: #f8d7da; color: #721c24; }
  .notification-warning { background-color: #fff3cd; color: #856404; }
  .notification-info { background-color: #d1ecf1; color: #0c5460; }
</style>
```

#### 5.2 Store de Notificaciones
```javascript
// src/lib/stores/notifications.store.ts
import { writable } from 'svelte/store';

interface Notification {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info';
  message: string;
  duration?: number;
}

const createNotificationsStore = () => {
  const { subscribe, update } = writable<Notification[]>([]);

  return {
    subscribe,
    add: (notification: Omit<Notification, 'id'>) => {
      const id = Date.now().toString();
      update(notifications => [...notifications, { ...notification, id }]);
    },
    remove: (id: string) => {
      update(notifications => notifications.filter(n => n.id !== id));
    },
    success: (message: string, duration?: number) => {
      this.add({ type: 'success', message, duration });
    },
    error: (message: string, duration?: number) => {
      this.add({ type: 'error', message, duration });
    },
    warning: (message: string, duration?: number) => {
      this.add({ type: 'warning', message, duration });
    },
    info: (message: string, duration?: number) => {
      this.add({ type: 'info', message, duration });
    }
  };
};

export const notificationsStore = createNotificationsStore();
```

### üìã Fase 6: Testing y Validaci√≥n

#### 6.1 Tests de Integraci√≥n
```javascript
// src/tests/integration/auth.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { api } from '$lib/services/axios';

describe('Authentication Integration', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('should login with valid credentials', async () => {
    const response = await api.post('/auth/login', {
      email: 'admin@company.com',
      password: '123456'
    });

    expect(response.status).toBe(200);
    expect(response.data).toHaveProperty('token');
    expect(response.data).toHaveProperty('user');
  });

  it('should handle invalid credentials', async () => {
    try {
      await api.post('/auth/login', {
        email: 'invalid@email.com',
        password: 'wrongpassword'
      });
    } catch (error: any) {
      expect(error.response.status).toBe(401);
    }
  });
});
```

#### 6.2 Tests de Validaci√≥n
```javascript
// src/tests/unit/validation.test.ts
import { describe, it, expect } from 'vitest';
import { validatePhone, validateMessage, validateFileUpload } from '$lib/utils/validation';

describe('Validation Utils', () => {
  describe('validatePhone', () => {
    it('should validate correct phone numbers', () => {
      expect(validatePhone('+521234567890')).toBe(true);
      expect(validatePhone('+1234567890')).toBe(true);
    });

    it('should reject invalid phone numbers', () => {
      expect(validatePhone('1234567890')).toBe(false);
      expect(validatePhone('+123')).toBe(false);
      expect(validatePhone('abc')).toBe(false);
    });
  });

  describe('validateMessage', () => {
    it('should accept valid messages', () => {
      const result = validateMessage('Hello world');
      expect(result.valid).toBe(true);
    });

    it('should reject messages too long', () => {
      const longMessage = 'a'.repeat(4097);
      const result = validateMessage(longMessage);
      expect(result.valid).toBe(false);
      expect(result.error).toContain('4096');
    });
  });
});
```

#### 6.3 Tests de Flujo Completo
```javascript
// src/tests/e2e/complete-flow.test.ts
describe('Complete User Flow', () => {
  it('should complete login ‚Üí chat ‚Üí logout flow', async () => {
    // 1. Login
    const loginResponse = await api.post('/auth/login', {
      email: 'admin@company.com',
      password: '123456'
    });
    expect(loginResponse.status).toBe(200);

    // 2. Load conversations
    const conversationsResponse = await api.get('/conversations');
    expect(conversationsResponse.status).toBe(200);

    // 3. Send message (if conversation exists)
    if (conversationsResponse.data.length > 0) {
      const conversationId = conversationsResponse.data[0].id;
      const messageResponse = await api.post(`/conversations/${conversationId}/messages`, {
        text: 'Test message'
      });
      expect(messageResponse.status).toBe(201);
    }

    // 4. Logout
    const logoutResponse = await api.post('/auth/logout');
    expect(logoutResponse.status).toBe(200);
  });

  it('should handle token expiration during long operations', async () => {
    // Simular expiraci√≥n de token durante upload de archivo grande
    // Verificar que se maneje TOKEN_EXPIRED_DURING_PROCESSING
  });

  it('should handle multiple users sending messages simultaneously', async () => {
    // Simular m√∫ltiples usuarios enviando mensajes al mismo tiempo
    // Verificar que no haya conflictos
  });
});
```

### üìã Fase 7: Monitoreo y M√©tricas

#### 7.1 Monitoreo de Rate Limiting
```javascript
// src/lib/services/monitoring.ts
class RateLimitMonitor {
  private warnings = new Set<string>();

  handleRateLimitHeaders(response: any) {
    const remaining = response.headers['X-RateLimit-Remaining'];
    const reset = response.headers['X-RateLimit-Reset'];
    
    if (remaining < 5 && !this.warnings.has('rate-limit')) {
      this.showWarning('Est√°s cerca del l√≠mite de peticiones');
      this.warnings.add('rate-limit');
    }
  }

  private showWarning(message: string) {
    // Mostrar notificaci√≥n al usuario
    notificationsStore.warning(message);
  }
}
```

#### 7.2 Performance Monitoring
```javascript
// src/lib/services/performance.ts
class PerformanceMonitor {
  trackApiCall(endpoint: string, duration: number) {
    console.log(`API Call to ${endpoint}: ${duration}ms`);
    
    if (duration > 5000) {
      console.warn(`Slow API call detected: ${endpoint}`);
    }
  }

  trackError(error: any) {
    console.error('API Error:', {
      status: error.response?.status,
      message: error.response?.data?.message,
      endpoint: error.config?.url,
      timestamp: new Date().toISOString()
    });
  }
}
```

---

## üéØ CONCLUSI√ìN

Este plan completo asegura que el frontend de UTalk est√© **100% alineado con el backend** y maneje correctamente todos los casos especiales, validaciones y estados que el sistema requiere.

### ‚úÖ Puntos Clave a Recordar:
1. **Usar siempre datos reales** - NO inventar informaci√≥n
2. **Seguir la documentaci√≥n del backend** como fuente √∫nica de verdad
3. **Implementar todas las validaciones** del lado cliente
4. **Manejar todos los edge cases** documentados
5. **No duplicar l√≥gica de negocio** en el frontend
6. **Probar con APIs reales** desde el primer d√≠a

### üöÄ Pr√≥ximos Pasos:
1. Implementar la configuraci√≥n base (Fase 1)
2. Desarrollar autenticaci√≥n (Fase 2)
3. Crear gesti√≥n de conversaciones (Fase 3)
4. Implementar chat en tiempo real (Fase 4)
5. Agregar manejo de errores (Fase 5)
6. Realizar testing completo (Fase 6)
7. Implementar monitoreo y m√©tricas (Fase 7)

### üìã Checklist Final de Verificaci√≥n
- [ ] **Configuraci√≥n de entornos** correcta
- [ ] **Headers de autorizaci√≥n** implementados
- [ ] **Validaciones de emojis** funcionando
- [ ] **Rate limiting** del lado cliente
- [ ] **Eventos de escritura** con debounce
- [ ] **Logs detallados** para debugging
- [ ] **Tests de flujo completo** pasando
- [ ] **Monitoreo de performance** activo
- [ ] **Manejo de errores** espec√≠ficos
- [ ] **Datos reales** en todas las pruebas

### üéØ Resultado Esperado
Siguiendo este plan completo, el frontend de UTalk estar√° **100% alineado con el backend**, manejando todos los casos especiales, validaciones y estados que el sistema requiere, sin inventar datos y trabajando siempre con informaci√≥n real del backend.

Siguiendo este plan paso a paso, el frontend quedar√° preparado para integrarse perfectamente con el backend actual y futuro de UTalk. 