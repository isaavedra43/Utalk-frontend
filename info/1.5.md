
## 🔧 INFORMACIÓN TÉCNICA ESPECÍFICA DEL BACKEND

### 📊 ESTRUCTURAS DE DATOS EXACTAS

#### 🔐 Respuesta de Login
```javascript
{
  "success": true,
  "data": {
    "user": {
      "id": "user@email.com",
      "email": "admin@company.com", 
      "name": "Admin User",
      "role": "admin",
      "isActive": true
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresIn": 3600
    }
  }
}
```

#### 💬 Estructura de Conversación
```javascript
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "participants": ["+521234567890", "admin@company.com"],
  "customerPhone": "+521234567890",
  "contact": {
    "id": "+521234567890",
    "name": "Juan Pérez",
    "avatar": null,
    "channel": "whatsapp"
  },
  "assignedTo": {
    "id": "admin@company.com",
    "name": "Admin User"
  },
  "status": "open",
  "priority": "normal",
  "tags": [],
  "unreadCount": 2,
  "messageCount": 15,
  "lastMessage": {
    "id": "msg_123",
    "content": "Hola, ¿cómo estás?",
    "timestamp": "2025-01-15T10:30:00Z",
    "sender": "customer",
    "type": "text"
  },
  "lastMessageId": "msg_123",
  "lastMessageAt": "2025-01-15T10:30:00Z",
  "createdAt": "2025-01-15T09:00:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### 💬 Estructura de Mensaje
```javascript
{
  "id": "msg_123",
  "conversationId": "550e8400-e29b-41d4-a716-446655440000",
  "content": "Hola, ¿cómo estás?",
  "mediaUrl": null,
  "senderIdentifier": "+521234567890",
  "recipientIdentifier": "admin@company.com",
  "sender": {
    "identifier": "+521234567890",
    "type": "customer"
  },
  "recipient": {
    "identifier": "admin@company.com", 
    "type": "agent"
  },
  "direction": "inbound",
  "type": "text",
  "status": "delivered",
  "timestamp": "2025-01-15T10:30:00Z",
  "metadata": {
    "twilioSid": "SM1234567890",
    "sentViaSocket": false,
    "socketId": null
  },
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### 📄 Respuesta Paginada
```javascript
{
  "success": true,
  "data": [/* array de items */],
  "pagination": {
    "hasMore": true,
    "nextCursor": "base64_encoded_cursor",
    "totalResults": 150,
    "limit": 20,
    "orderBy": "timestamp",
    "order": "desc"
  },
  "metadata": {
    "queryTime": "150ms",
    "appliedFilters": ["status: open", "assignedTo: admin@company.com"]
  }
}
```

---

## 🚀 IMPLEMENTACIÓN PASO A PASO

### 📋 Fase 1: Configuración Base

#### 1.1 Configurar Interceptores de Axios
```javascript
// src/lib/services/axios.ts
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
});

// Interceptor de requests
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  config.headers.Authorization = `Bearer ${token || ''}`;
  return config;
});

// Interceptor de responses
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      if (error.response?.data?.code === 'TOKEN_EXPIRED_DURING_PROCESSING') {
        await refreshToken();
        return api.request(error.config);
      }
      // Logout si token expirado
      logout();
    }
    return Promise.reject(error);
  }
);
```

#### 1.2 Configurar Socket.IO
```javascript
// src/lib/services/socket.ts
import { io } from 'socket.io-client';

class SocketManager {
  private socket: any;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect() {
    this.socket = io(import.meta.env.VITE_SOCKET_URL, {
      auth: {
        token: localStorage.getItem('token')
      },
      transports: ['websocket', 'polling'],
      timeout: 30000,
      forceNew: true
    });

    this.setupEventListeners();
  }

  private setupEventListeners() {
    this.socket.on('disconnect', () => {
      this.reconnect();
    });

    this.socket.on('connect', () => {
      this.reconnectAttempts = 0;
      this.socket.emit('sync-state');
    });
  }

  private reconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
      setTimeout(() => {
        this.connect();
        this.reconnectAttempts++;
      }, delay);
    }
  }
}
```

#### 1.3 Crear Utilidades de Validación
```javascript
// src/lib/utils/validation.ts
export const validatePhone = (phone: string): boolean => {
  const phoneRegex = /^\+[1-9]\d{1,14}$/;
  return phoneRegex.test(phone);
};

export const validateMessage = (text: string): { valid: boolean; error?: string } => {
  if (text.length > 4096) {
    return { valid: false, error: "Mensaje demasiado largo (máximo 4096 caracteres)" };
  }
  return { valid: true };
};

export const validateFileUpload = (files: File[]): { valid: boolean; error?: string } => {
  if (files.length > 10) {
    return { valid: false, error: "Máximo 10 archivos por mensaje" };
  }

  for (const file of files) {
    if (file.size > 100 * 1024 * 1024) { // 100MB
      return { valid: false, error: `Archivo ${file.name} excede 100MB` };
    }
  }

  return { valid: true };
};
```

#### 1.4 Crear Utilidades de Fechas
```javascript
// src/lib/utils/dates.ts
export const safeDateToISOString = (date: any): string | null => {
  if (!date) return null;
  
  if (typeof date === 'string') {
    return date;
  }
  
  if (typeof date === 'number') {
    return new Date(date).toISOString();
  }
  
  if (date._seconds) {
    // Firestore timestamp
    return new Date(date._seconds * 1000).toISOString();
  }
  
  if (date instanceof Date) {
    return date.toISOString();
  }
  
  return null;
};
```

#### 1.2 Configurar Socket.IO
```javascript
// src/lib/services/socket.ts
import { io } from 'socket.io-client';

class SocketManager {
  private socket: any;
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect() {
    this.socket = io(import.meta.env.VITE_SOCKET_URL, {
      auth: {
        token: localStorage.getItem('token')
      }
    });

    this.setupEventListeners();
  }

  private setupEventListeners() {
    this.socket.on('disconnect', () => {
      this.reconnect();
    });

    this.socket.on('connect', () => {
      this.reconnectAttempts = 0;
      this.socket.emit('sync-state');
    });
  }

  private reconnect() {
    if (this.reconnectAttempts < this.maxReconnectAttempts) {
      const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
      setTimeout(() => {
        this.connect();
        this.reconnectAttempts++;
      }, delay);
    }
  }
}
```

#### 1.3 Crear Utilidades de Validación
```javascript
// src/lib/utils/validation.ts
export const validatePhone = (phone: string): boolean => {
  const phoneRegex = /^\+[1-9]\d{1,14}$/;
  return phoneRegex.test(phone);
};

export const validateMessage = (text: string): { valid: boolean; error?: string } => {
  if (text.length > 4096) {
    return { valid: false, error: "Mensaje demasiado largo (máximo 4096 caracteres)" };
  }
  return { valid: true };
};

export const validateFileUpload = (files: File[]): { valid: boolean; error?: string } => {
  if (files.length > 10) {
    return { valid: false, error: "Máximo 10 archivos por mensaje" };
  }

  for (const file of files) {
    if (file.size > 100 * 1024 * 1024) { // 100MB
      return { valid: false, error: `Archivo ${file.name} excede 100MB` };
    }
  }

  return { valid: true };
};
```

#### 1.4 Crear Utilidades de Fechas
```javascript
// src/lib/utils/dates.ts
export const safeDateToISOString = (date: any): string | null => {
  if (!date) return null;
  
  if (typeof date === 'string') {
    return date;
  }
  
  if (typeof date === 'number') {
    return new Date(date).toISOString();
  }
  
  if (date._seconds) {
    // Firestore timestamp
    return new Date(date._seconds * 1000).toISOString();
  }
  
  if (date instanceof Date) {
    return date.toISOString();
  }
  
  return null;
};
```

### 📋 Fase 2: Autenticación y Autorización

#### 2.1 Store de Autenticación
```javascript
// src/lib/stores/auth.store.ts
import { writable } from 'svelte/store';

interface User {
  id: string;
  email: string;
  role: 'admin' | 'agent' | 'viewer';
  name: string;
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
}

const createAuthStore = () => {
  const { subscribe, set, update } = writable<AuthState>({
    user: null,
    token: null,
    isAuthenticated: false
  });

  return {
    subscribe,
    login: (user: User, token: string) => {
      localStorage.setItem('token', token);
      set({ user, token, isAuthenticated: true });
    },
    logout: () => {
      localStorage.removeItem('token');
      set({ user: null, token: null, isAuthenticated: false });
    },
    updateUser: (user: User) => {
      update(state => ({ ...state, user }));
    }
  };
};

export const authStore = createAuthStore();
```

#### 2.2 Componente de Login
```svelte
<!-- src/routes/login/+page.svelte -->
<script lang="ts">
  import { authStore } from '$lib/stores/auth.store';
  import { api } from '$lib/services/axios';
  import { validatePhone } from '$lib/utils/validation';
  
  let email = '';
  let password = '';
  let error = '';
  let loading = false;

  async function handleLogin() {
    loading = true;
    error = '';
    
    try {
      const response = await api.post('/auth/login', { email, password });
      authStore.login(response.data.user, response.data.token);
      
      // Redirigir al dashboard
      window.location.href = '/dashboard';
    } catch (err: any) {
      error = err.response?.data?.message || 'Error al iniciar sesión';
    } finally {
      loading = false;
    }
  }
</script>

<form on:submit|preventDefault={handleLogin}>
  <input 
    type="email" 
    bind:value={email} 
    placeholder="Email" 
    required 
  />
  <input 
    type="password" 
    bind:value={password} 
    placeholder="Contraseña" 
    required 
  />
  <button type="submit" disabled={loading}>
    {loading ? 'Iniciando...' : 'Iniciar Sesión'}
  </button>
  
  {#if error}
    <div class="error">{error}</div>
  {/if}
</form>
```

### 📋 Fase 3: Gestión de Conversaciones

#### 3.1 Store de Conversaciones
```javascript
// src/lib/stores/conversations.store.ts
import { writable } from 'svelte/store';
import { api } from '$lib/services/axios';

interface Message {
  id: string;
  text: string;
  sender: string;
  timestamp: string;
  status: 'sent' | 'delivered' | 'failed';
  metadata?: {
    failureReason?: string;
    retryable?: boolean;
  };
}

interface Conversation {
  id: string;
  contact?: {
    id: string;
    name?: string;
    phone: string;
  };
  assignedTo?: string | null;
  lastMessage?: Message | null;
  messageCount: number;
  unreadCount: number;
  createdAt: string;
  updatedAt: string;
}

const createConversationsStore = () => {
  const { subscribe, set, update } = writable<Conversation[]>([]);

  return {
    subscribe,
    loadConversations: async () => {
      try {
        const response = await api.get('/conversations');
        set(response.data);
      } catch (error) {
        console.error('Error loading conversations:', error);
        set([]);
      }
    },
    addMessage: (conversationId: string, message: Message) => {
      update(conversations => 
        conversations.map(conv => 
          conv.id === conversationId 
            ? { ...conv, lastMessage: message, messageCount: conv.messageCount + 1 }
            : conv
        )
      );
    },
    updateConversation: (conversationId: string, updates: Partial<Conversation>) => {
      update(conversations =>
        conversations.map(conv =>
          conv.id === conversationId ? { ...conv, ...updates } : conv
        )
      );
    }
  };
};

export const conversationsStore = createConversationsStore();
```

#### 3.2 Componente de Lista de Conversaciones
