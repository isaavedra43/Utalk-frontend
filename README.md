# UTalk Frontend

Sistema de chat profesional tipo Slack construido con SvelteKit + TypeScript.

## üöÄ Caracter√≠sticas Principales

- ‚úÖ **Autenticaci√≥n segura** con JWT y HttpOnly cookies
- ‚úÖ **Sistema de logging ultra robusto** basado en est√°ndares de observabilidad moderna
- ‚úÖ **Arquitectura limpia** con separaci√≥n de responsabilidades
- ‚úÖ **TypeScript estricto** con tipos robustos
- ‚úÖ **UI moderna** con Tailwind CSS y shadcn-svelte
- ‚úÖ **Testing** con Vitest y Testing Library
- ‚úÖ **Validaci√≥n autom√°tica** con ESLint, Prettier y Husky

## ‚ö†Ô∏è **ALINEACI√ìN CR√çTICA CON BACKEND**

**IMPORTANTE:** Este frontend est√° espec√≠ficamente alineado con el backend UTalk desplegado en Railway. Se han realizado correcciones cr√≠ticas para asegurar compatibilidad total:

### üöÄ **CORRECCI√ìN CR√çTICA: Error 500 Vercel Serverless (v1.2.0)**

**Problema resuelto:** El frontend desplegado en Vercel generaba error 500 al intentar hacer login debido a que las variables de entorno no se resolv√≠an correctamente en el runtime de las funciones serverless.

**Diagn√≥stico confirmado:**

- ‚úÖ Variables configuradas correctamente en Vercel Dashboard
- ‚úÖ Backend en Railway funcionando perfectamente
- ‚ùå Function serverless fallando al resolver `process.env.API_URL`
- ‚ùå Usando fallback `localhost:3001` causando error de conexi√≥n

**Soluci√≥n implementada:**

- ‚úÖ **Funci√≥n `getEnvVar` mejorada** para contexto serverless de Vercel
- ‚úÖ **Logs detallados** para debugging de variables en runtime
- ‚úÖ **Rutas corregidas** eliminando duplicaci√≥n de `/api`
- ‚úÖ **Validaci√≥n estricta** con alertas de fallbacks problem√°ticos

**Archivos modificados:**

- `src/lib/env.ts` - Funci√≥n de resoluci√≥n de variables mejorada
- `src/lib/services/auth.service.ts` - Rutas de endpoints corregidas

**Verificaci√≥n del fix:**

```bash
# En logs de Vercel ahora aparece:
‚úÖ Variables de entorno resueltas correctamente en Vercel
‚úÖ API_BASE_URL: https://utalk-backend-production.up.railway.app/api
```

### üîß **Correcci√≥n Header Authorization (v1.1.0)**

**Problema resuelto:** El backend requiere el header `Authorization: Bearer` en **TODAS** las requests, incluso en el login inicial donde a√∫n no hay token.

**Soluci√≥n implementada:**

- ‚úÖ Interceptor Axios configurado para enviar **SIEMPRE** `Authorization: Bearer {token|''}`
- ‚úÖ Token almacenado en `localStorage` tras login exitoso
- ‚úÖ Token limpiado en logout para enviar header vac√≠o
- ‚úÖ Refresh token actualiza autom√°ticamente el token almacenado

**Archivos modificados:**

- `src/lib/services/axios.ts` - Interceptor con header obligatorio
- `src/lib/services/auth.service.ts` - Almacenamiento/limpieza de token

**Referencia:** Basado en `BACKEND_ADVANCED_LOGIC_CORREGIDO.md` y `DOCUMENTACION_COMPLETA_BACKEND_UTALK.md`

**Verificaci√≥n:**

```bash
# El login debe funcionar correctamente con estas credenciales:
# Email: admin@company.com
# Password: 123456
npm run dev
# Navegar a /login y probar autenticaci√≥n
```

## üìã Tabla de Contenidos

- [Instalaci√≥n](#instalaci√≥n)
- [Desarrollo](#desarrollo)
- [Sistema de Logging](#sistema-de-logging)
- [Arquitectura](#arquitectura)
- [Testing](#testing)
- [Producci√≥n](#producci√≥n)

## üõ†Ô∏è Instalaci√≥n

### Requisitos del Sistema

- **Node.js**: >= 20.0.0 (recomendado: 20.x LTS)
- **npm**: >= 8.0.0

```bash
# Verificar versi√≥n de Node.js
node --version  # Debe ser >= 20.0.0

# Clonar el repositorio
git clone https://github.com/tu-usuario/utalk-frontend.git
cd utalk-frontend

# Instalar dependencias
npm install

# Configurar variables de entorno para desarrollo local
cp .env.example .env.local

# Iniciar servidor de desarrollo
npm run dev
```

### ‚ö†Ô∏è **CONFIGURACI√ìN CR√çTICA DE VARIABLES DE ENTORNO EN VERCEL**

**Para que el login funcione en producci√≥n, DEBES configurar estas variables en Vercel Dashboard:**

#### **1. Variables para el Cliente (VITE\_\*):**

```
VITE_API_URL = https://utalk-backend-production.up.railway.app/api
VITE_WS_URL = wss://utalk-backend-production.up.railway.app
```

#### **2. Variables para el Servidor (sin VITE\_\*):**

```
API_URL = https://utalk-backend-production.up.railway.app/api
WS_URL = wss://utalk-backend-production.up.railway.app
```

#### **3. Pasos para configurar en Vercel:**

1. Ve a tu proyecto en [Vercel Dashboard](https://vercel.com/dashboard)
2. Settings ‚Üí Environment Variables
3. Agrega **AMBOS** tipos de variables (VITE*\* y sin VITE*\*)
4. Selecciona **Production, Preview, Development** para todas
5. **Redeploy** el proyecto despu√©s de agregar las variables

#### **4. Verificaci√≥n:**

```bash
# Las variables deben aparecer en los logs de build como:
üåê BACKEND CONFIG: {
  API_BASE_URL: 'https://utalk-backend-production.up.railway.app/api', // ‚úÖ CORRECTO
  env: 'server',
  serverEnv: { API_URL: 'https://...', VITE_API_URL: 'https://...' }  // ‚úÖ AMBAS DISPONIBLES
}
```

**‚ùå Si ves `localhost:3001` en los logs, las variables NO est√°n configuradas correctamente.**

## üèóÔ∏è Desarrollo

```bash
# Servidor de desarrollo
npm run dev

# Build de producci√≥n
npm run build

# Preview del build
npm run preview

# Validaci√≥n completa
npm run validate
```

## üìä Sistema de Logging

UTalk Frontend incluye un **sistema de logging ultra robusto** basado en est√°ndares de observabilidad moderna de empresas como Netflix, Google, Stripe y Vercel.

### Caracter√≠sticas del Logger

- **üéØ Logging estructurado** con niveles RFC5424 (FATAL, ERROR, WARN, INFO, DEBUG, TRACE, EVENT)
- **üöÄ M√∫ltiples transportes** (Console, LocalStorage, Remote endpoints)
- **‚ö° Interceptores autom√°ticos** para Axios, Fetch y Socket.io
- **üìà Performance monitoring** integrado
- **üçû Error tracking** con breadcrumbs para trazabilidad
- **üîí Sanitizaci√≥n autom√°tica** de datos sensibles
- **üõ°Ô∏è Throttling** para prevenir spam de logs
- **üìä M√©tricas de observabilidad** en tiempo real
- **üíæ Export/import** de logs para auditor√≠a

### Uso B√°sico

```typescript
import { logger } from '$lib/logger';

// Logging b√°sico
logger.info('Usuario autenticado', { userId: '123' });
logger.error('Error de login', error);
logger.warn('Respuesta lenta del servidor');
logger.debug('Datos de depuraci√≥n', { data });

// Logging especializado
logger.logUserAction('login_attempt');
logger.logPerformance('api_call', 250);
logger.logNetwork('POST', '/api/auth/login', { status: 200 });

// Event logging para analytics
logger.event('button_click', {
  user: {
    action: 'cta_click',
    component: 'hero',
    metadata: { buttonText: 'Get Started' }
  }
});
```

### Configuraci√≥n Avanzada

```typescript
import { configureLogger, LogLevel, setupAxiosInterceptors } from '$lib/logger';

// Configurar logger personalizado
const logger = configureLogger({
  level: LogLevel.DEBUG,
  enableStorage: true,
  enableRemote: true,
  remoteEndpoint: 'https://api.yourdomain.com/logs',
  batchSize: 20,
  flushInterval: 5000,
  sensitiveFields: ['password', 'token', 'apiKey']
});

// Configurar interceptores autom√°ticos
setupAxiosInterceptors(axiosInstance);
setupPerformanceMonitor();
```

### Integraci√≥n con Servicios Externos

El logger est√° preparado para integrarse con servicios de observabilidad:

#### Sentry

```typescript
// El logger incluye un transport para Sentry listo para usar
// Solo necesitas instalar e inicializar Sentry
import * as Sentry from '@sentry/browser';

Sentry.init({
  dsn: 'YOUR_SENTRY_DSN'
});

// Los errores FATAL y ERROR se env√≠an autom√°ticamente a Sentry
```

#### Datadog, Elastic, Axiom

```typescript
// Configurar endpoint remoto
const logger = configureLogger({
  enableRemote: true,
  remoteEndpoint: 'https://http-intake.logs.datadoghq.com/v1/input/YOUR_API_KEY',
  batchSize: 50,
  flushInterval: 10000
});
```

### M√©tricas y Monitoreo

```typescript
import { logger } from '$lib/logger';

// Obtener m√©tricas del logger
const metrics = logger.getMetrics();
console.log('Total logs:', metrics.totalLogs);
console.log('Error rate:', metrics.errorRate);
console.log('Logs por nivel:', metrics.logsByLevel);

// Exportar logs para auditor√≠a
const logsBlob = await logger.export();
const url = URL.createObjectURL(logsBlob);
const a = document.createElement('a');
a.href = url;
a.download = 'utalk-logs.json';
a.click();
```

### Configuraci√≥n por Entorno

El logger se auto-configura seg√∫n el entorno:

- **Development**: Logs DEBUG+, storage habilitado, console verbose
- **Staging**: Logs INFO+, storage habilitado, remote opcional
- **Production**: Logs WARN+, solo remote, optimizado para performance

### Interceptores Autom√°ticos

```typescript
// Los interceptores se configuran autom√°ticamente en desarrollo
// Para configuraci√≥n manual:

// Axios
setupAxiosInterceptors(axiosInstance, {
  logRequests: true,
  logResponses: true,
  logErrors: true,
  excludeUrls: ['/ping', '/health']
});

// Fetch nativo
setupFetchInterceptor({
  logPerformance: true,
  maxBodySize: 1024
});

// Performance global
setupPerformanceMonitor(); // Auto-detecta Long Tasks, Page Load, etc.
```

### Logging de Seguridad

```typescript
// El logger autom√°ticamente sanitiza datos sensibles
logger.info('Login attempt', {
  email: 'user@example.com',
  password: 'secret123', // Se convierte autom√°ticamente en '[REDACTED]'
  token: 'jwt-token' // Se convierte autom√°ticamente en '[REDACTED]'
});

// Campos sensibles configurables
const logger = configureLogger({
  sensitiveFields: ['password', 'token', 'apiKey', 'secret', 'ssn', 'creditCard']
});
```

## üèõÔ∏è Arquitectura

### Estructura del Proyecto

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ logger/              # Sistema de logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts         # Logger principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts         # Tipos e interfaces
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.ts         # Utilidades y helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transports.ts    # Transportes (console, storage, remote)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ interceptors.ts  # Interceptores autom√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Servicios de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts  # Autenticaci√≥n (con logging integrado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ axios.ts         # Cliente HTTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ socket.ts        # WebSocket cliente
‚îÇ   ‚îú‚îÄ‚îÄ stores/              # Stores de Svelte
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.store.ts    # Estado de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.store.ts    # Estado de p√°gina
‚îÇ   ‚îú‚îÄ‚îÄ types/               # Tipos TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts          # Tipos de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ http.ts          # Tipos HTTP/API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui.ts            # Tipos de UI
‚îÇ   ‚îî‚îÄ‚îÄ components/          # Componentes reutilizables
‚îú‚îÄ‚îÄ routes/                  # Rutas de SvelteKit
‚îî‚îÄ‚îÄ tests/                   # Tests
```

### Principios de Logging

1. **Estructurado**: Todos los logs son JSON estructurados
2. **Contextual**: Cada log incluye contexto relevante (m√≥dulo, funci√≥n, usuario)
3. **Seguro**: Datos sensibles autom√°ticamente sanitizados
4. **Performante**: Throttling y batching para no impactar performance
5. **Observable**: M√©tricas y trazabilidad completa
6. **Escalable**: M√∫ltiples transportes y configuraci√≥n por entorno

## üß™ Testing

```bash
# Ejecutar todos los tests
npm run test

# Tests en modo watch
npm run test:watch

# Tests de integraci√≥n
npm run test:integration

# Coverage
npm run test:coverage
```

## üöÄ Producci√≥n

```bash
# Build optimizado
npm run build

# Validar antes de desplegar
npm run validate

# Desplegar (ejemplo con Vercel)
vercel --prod
```

### Configuraci√≥n de Producci√≥n

En producci√≥n, el logger se optimiza autom√°ticamente:

- Solo logs WARN+ para reducir volumen
- Remote transport habilitado para centralizaci√≥n
- Batching agresivo para performance
- M√©tricas de error rate y performance

## üìö Recursos Adicionales

- [SvelteKit Documentation](https://kit.svelte.dev/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Tailwind CSS](https://tailwindcss.com/)
- [shadcn-svelte](https://www.shadcn-svelte.com/)
- [OpenTelemetry](https://opentelemetry.io/)
- [RFC5424 - Syslog Protocol](https://tools.ietf.org/html/rfc5424)

## üìù Changelog

### 2025-01-04 - v1.0.0

- ‚úÖ Sistema de autenticaci√≥n completo
- ‚úÖ **Sistema de logging ultra robusto implementado**
- ‚úÖ Interceptores autom√°ticos para monitoring
- ‚úÖ Performance tracking integrado
- ‚úÖ Error handling con breadcrumbs
- ‚úÖ Sanitizaci√≥n de datos sensibles
- ‚úÖ M√©tricas de observabilidad
- ‚úÖ Integraci√≥n lista para servicios externos
- ‚úÖ Configuraci√≥n autom√°tica por entorno
- ‚úÖ Documentaci√≥n completa del logger

---

**Desarrollado con ‚ù§Ô∏è por el equipo de UTalk**
